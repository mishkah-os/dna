<!DOCTYPE html>
<html lang="ar" dir="rtl" data-htmlx="playground" data-css-library="mi" data-theme="dark">

<head>
    <meta charset="utf-8">
    <title>Mishkah Playground</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <script>
        window.MishkahAutoConfig = {
            css: 'mi',
            paths: {
                utils: '../lib/mishkah-utils.js',
                core: '../lib/mishkah.core.js',
                ui: '../lib/mishkah-ui.js',
                htmlx: '../lib/mishkah-htmlx.js'
            }
        };
    </script>
    <script src="../lib/mishkah.js" data-htmlx data-css="mi"></script>
    <script src="playground-examples.js"></script>

    <!-- CodeMirror UMD -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

    <script>
        (function () {
            if (window.MishkahAuto && typeof window.MishkahAuto.ready === 'function') {
                window.MishkahAuto.ready(function (M) {
                    var htmlxAttr = document.documentElement.getAttribute('data-htmlx');
                    if (htmlxAttr && M && M.app && typeof M.app.make === 'function') {
                        M.app.make();
                    }
                });
            }
        })();
    </script>
</head>

<body class="bg-slate-900 text-slate-100">
    <div id="app"></div>

    <template id="playground">
        <!-- THIS IS THE CORRECT TEMPLATE ID MATCHING data-htmlx="playground" -->
        <script type="application/json" data-m-env data-m-path="env">
      {"theme":"dark","lang":"ar"}
    </script>

        <script type="application/json" data-m-data data-m-path="data">
      {"currentExample":"counter","searchQuery":"","categories":[]}
    </script>

        <div data-m-scope="playground" class="h-screen flex flex-col">
            <header class="h-16 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üé®</span>
                    <span class="text-xl font-bold text-purple-400">Mishkah Playground</span>
                </div>
                <div class="flex gap-2">
                    <button data-m-order="toggleTheme" class="px-4 py-2 bg-slate-700 rounded-lg">
                        <span x-if="state.env.theme==='dark'">üåô Dark</span>
                        <span x-if="state.env.theme==='light'">‚òÄÔ∏è Light</span>
                    </button>
                    <button data-m-order="downloadCode" class="px-4 py-2 bg-purple-600 text-white rounded-lg">üì•
                        Download</button>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden">
                <aside class="w-72 bg-slate-800 border-r border-slate-700 overflow-y-auto p-4">
                    <h3 class="text-lg font-bold mb-4">Examples</h3>
                    <div x-for="category in state.data.categories" key="category.id" class="mb-4">
                        <div class="text-xs font-semibold text-slate-400 uppercase mb-2">{category.nameAr}</div>
                        <div x-for="example in category.examples" key="example.id" data-m-order="selectExample"
                            x-bind:data-example-id="example.id"
                            x-bind:class="state.data.currentExample===example.id?'bg-purple-600':'bg-slate-700'"
                            class="p-2 mb-1 rounded cursor-pointer">
                            {example.titleAr}
                        </div>
                    </div>
                </aside>

                <div class="flex-1 flex flex-col">
                    <div class="flex-1 border-b border-slate-700">
                        <div class="h-12 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4">
                            <span>üìù Editor</span>
                            <button data-m-order="runCode" class="px-3 py-1 bg-purple-600 text-white rounded">‚ñ∂Ô∏è
                                Run</button>
                        </div>
                        <div id="editor" class="h-full"></div>
                    </div>

                    <div class="flex-1">
                        <div class="h-12 bg-slate-800 border-b border-slate-700 flex items-center px-4">
                            <span>üëÅÔ∏è Preview</span>
                        </div>
                        <iframe id="preview" class="w-full h-full bg-white border-0"
                            sandbox="allow-scripts allow-same-origin"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var editor = null;

            function updatePreview() {
                if (!editor) return;
                var code = editor.getValue();
                var iframe = document.getElementById('preview');
                if (!iframe) return;
                var doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
            }

            function loadCategories() {
                if (!window.PlaygroundExamples) return [];
                var cats = window.PlaygroundExamples.getCategories();
                return cats.map(function (cat) {
                    return {
                        id: cat.id,
                        nameAr: cat.nameAr,
                        icon: cat.icon,
                        examples: window.PlaygroundExamples.getExamplesByCategory(cat.id)
                    };
                });
            }

            function initEditor(code) {
                setTimeout(function () {
                    var container = document.getElementById('editor');
                    if (!container || !window.CodeMirror) return;

                    editor = CodeMirror(container, {
                        value: code || '',
                        mode: 'htmlmixed',
                        theme: 'dracula',
                        lineNumbers: true,
                        lineWrapping: true
                    });

                    editor.on('change', updatePreview);
                    updatePreview();
                }, 500);
            }

            // Initialize after DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    var example = window.PlaygroundExamples ? window.PlaygroundExamples.getExample('counter') : null;
                    initEditor(example ? example.code : '');
                });
            } else {
                var example = window.PlaygroundExamples ? window.PlaygroundExamples.getExample('counter') : null;
                initEditor(example ? example.code : '');
            }
        </script>
    </template>

    <script>
        window.playgroundOrders = {
            toggleTheme: {
                on: ['click'],
                handler: function (evt, app) {
                    app.setState(function (s) {
                        s.env.theme = s.env.theme === 'dark' ? 'light' : 'dark';
                        document.documentElement.setAttribute('data-theme', s.env.theme);
                        return s;
                    });
                }
            },
            downloadCode: {
                on: ['click'],
                handler: function () {
                    if (!window.editor) return;
                    var code = window.editor.getValue();
                    var blob = new Blob([code], { type: 'text/html' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'example.html';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            },
            runCode: {
                on: ['click'],
                handler: function () {
                    if (window.updatePreview) window.updatePreview();
                }
            },
            selectExample: {
                on: ['click'],
                handler: function (evt, app) {
                    var el = evt.target.closest('[data-example-id]');
                    if (!el) return;
                    var exampleId = el.getAttribute('data-example-id');
                    if (!exampleId || !window.PlaygroundExamples) return;

                    var example = window.PlaygroundExamples.getExample(exampleId);
                    if (!example) return;

                    app.setState(function (s) {
                        s.data.currentExample = exampleId;
                        return s;
                    });

                    if (window.editor) {
                        window.editor.setValue(example.code);
                        if (window.updatePreview) window.updatePreview();
</html >