<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Mishkah Playground - Interactive Code Editor</title>

    <!-- Mishkah Framework -->
    <script>window.MishkahAutoConfig = { css: 'mi' };</script>
    <script src="../lib/mishkah.js" data-htmlx data-css="mi"></script>

    <!-- CodeMirror 6 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --header-height: 60px;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Cairo', 'Tajawal', system-ui, sans-serif;
            background: var(--background, #0f172a);
            color: var(--foreground, #e2e8f0);
            height: 100vh;
            overflow: hidden;
        }

        .playground-container {
            display: grid;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
        }

        /* Header */
        .playground-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            background: var(--card, #1e293b);
            border-bottom: 1px solid var(--border, #334155);
        }

        .playground-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary, #667eea);
        }

        .playground-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Main Layout */
        .playground-main {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: calc(100vh - var(--header-height));
            overflow: hidden;
        }

        /* Sidebar */
        .playground-sidebar {
            background: var(--card, #1e293b);
            border-left: 1px solid var(--border, #334155);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border, #334155);
        }

        .sidebar-search {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--surface-1, #0f172a);
            border: 1px solid var(--border, #334155);
            border-radius: 8px;
            color: var(--foreground, #e2e8f0);
            font-size: 0.875rem;
        }

        .sidebar-categories {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .category-group {
            margin-bottom: 1rem;
        }

        .category-title {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted-foreground, #94a3b8);
        }

        .example-item {
            padding: 0.75rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .example-item:hover {
            background: var(--accent, #667eea20);
        }

        .example-item.active {
            background: var(--primary, #667eea);
            color: white;
        }

        .difficulty-badge {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            background: var(--surface-2, #1e293b);
        }

        /* Editor & Preview */
        .playground-workspace {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 0;
            overflow: hidden;
        }

        .editor-panel,
        .preview-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--surface-1, #0f172a);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--card, #1e293b);
            border-bottom: 1px solid var(--border, #334155);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-container {
            flex: 1;
            overflow: auto;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: white;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary, #667eea);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark, #5558dd);
        }

        .btn-secondary {
            background: var(--surface-2, #1e293b);
            color: var(--foreground, #e2e8f0);
        }

        .btn-secondary:hover {
            background: var(--surface-3, #334155);
        }

        .btn-icon {
            padding: 0.5rem;
            aspect-ratio: 1;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 240px;
            }
        }

        @media (max-width: 768px) {
            .playground-main {
                grid-template-columns: 1fr;
            }

            .playground-sidebar {
                display: none;
            }

            .playground-workspace {
                grid-template-rows: 1fr;
            }

            .editor-panel {
                display: none;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--muted-foreground, #94a3b8);
        }

        /* CodeMirror Styles */
        .cm-editor {
            height: 100%;
            font-size: 14px;
            direction: ltr;
        }

        .cm-scroller {
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <template id="playground">
        <!-- ENV -->
        <script type="application/json" data-m-env data-m-path="env">
      {
        "theme": "dark",
        "lang": "ar",
        "title": "Mishkah Playground"
      }
    </script>

        <!-- DATA -->
        <script type="application/json" data-m-data data-m-path="data">
      {
        "currentExample": null,
        "examples": [],
        "categories": [
          { "id": "basic", "name": "Basic", "nameAr": "ÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™", "count": 4 },
          { "id": "forms", "name": "Forms", "nameAr": "ŸÜŸÖÿßÿ∞ÿ¨", "count": 4 },
          { "id": "ui", "name": "UI Components", "nameAr": "ŸÖŸÉŸàŸÜÿßÿ™ Ÿàÿßÿ¨Ÿáÿ©", "count": 6 },
          { "id": "charts", "name": "Charts", "nameAr": "ÿ±ÿ≥ŸàŸÖ ÿ®ŸäÿßŸÜŸäÿ©", "count": 4 },
          { "id": "tables", "name": "Tables", "nameAr": "ÿ¨ÿØÿßŸàŸÑ", "count": 4 },
          { "id": "advanced", "name": "Advanced", "nameAr": "ŸÖÿ™ŸÇÿØŸÖ", "count": 4 },
          { "id": "pwa", "name": "PWA", "nameAr": "PWA", "count": 4 },
          { "id": "mobile", "name": "Mobile UI", "nameAr": "Ÿàÿßÿ¨Ÿáÿ© ŸÖŸàÿ®ÿßŸäŸÑ", "count": 4 }
        ],
        "searchQuery": "",
        "code": "<!-- Loading... -->",
        "previewUrl": ""
      }
    </script>

        <!-- TEMPLATE -->
        <div data-m-scope="playground" class="playground-container">
            <!-- Header -->
            <header class="playground-header">
                <div class="playground-logo">
                    <span>üé®</span>
                    <span>Mishkah Playground</span>
                </div>
                <div class="playground-actions">
                    <button class="btn btn-secondary" data-m-order="toggleTheme">
                        <span x-if="state.env.theme === 'dark'">üåô</span>
                        <span x-if="state.env.theme === 'light'">‚òÄÔ∏è</span>
                    </button>
                    <button class="btn btn-primary" data-m-order="downloadCode">
                        üì• Download
                    </button>
                </div>
            </header>

            <!-- Main -->
            <div class="playground-main">
                <!-- Sidebar -->
                <aside class="playground-sidebar">
                    <div class="sidebar-header">
                        <input type="text" class="sidebar-search" placeholder="ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ£ŸÖÿ´ŸÑÿ©..."
                            data-m-order="searchExamples" x-bind:value="state.data.searchQuery">
                    </div>
                    <div class="sidebar-categories">
                        <div x-for="category in state.data.categories" key="category.id" class="category-group">
                            <div class="category-title">
                                {category.nameAr} ({category.count})
                            </div>
                            <div class="example-item" data-m-order="selectExample" x-bind:data-example-id="'counter'">
                                <span>Counter Example</span>
                                <span class="difficulty-badge">‚≠ê</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Workspace -->
                <div class="playground-workspace">
                    <!-- Editor -->
                    <div class="editor-panel">
                        <div class="panel-header">
                            <span>üìù Code Editor</span>
                            <div class="panel-actions">
                                <button class="btn btn-icon btn-secondary" data-m-order="formatCode"
                                    title="Format Code">
                                    ‚ú®
                                </button>
                                <button class="btn btn-icon btn-primary" data-m-order="runCode"
                                    title="Run (Ctrl+Enter)">
                                    ‚ñ∂Ô∏è
                                </button>
                            </div>
                        </div>
                        <div id="editor-container" class="editor-container">
                            <div class="loading">Loading editor...</div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="preview-panel">
                        <div class="panel-header">
                            <span>üëÅÔ∏è Live Preview</span>
                            <div class="panel-actions">
                                <button class="btn btn-icon btn-secondary" data-m-order="refreshPreview"
                                    title="Refresh">
                                    üîÑ
                                </button>
                                <button class="btn btn-icon btn-secondary" data-m-order="openInNewTab"
                                    title="Open in new tab">
                                    üîó
                                </button>
                            </div>
                        </div>
                        <iframe id="preview-frame" class="preview-frame"
                            sandbox="allow-scripts allow-same-origin"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOGIC -->
        <script>
            // Default example code
            const defaultCode = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mishkah Example</title>
  <script>window.MishkahAutoConfig = { css: 'mi' };<\/script>
  <script src="/lib/mishkah.js" data-htmlx><\/script>
</head>
<body>
  <div id="app"></div>
  
  <template id="example">
    <script type="application/json" data-m-data data-m-path="data">
      { "count": 0 }
    <\/script>
    
    <div data-m-scope="example" style="padding: 2rem; text-align: center;">
      <h1>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä Mishkah Playground!</h1>
      <p style="margin: 1rem 0;">ÿßŸÑÿπÿØÿßÿØ: {state.data.count}</p>
      <button data-m-order="increment" style="padding: 0.5rem 1rem; font-size: 1rem;">
        ÿ≤ŸäÿßÿØÿ©
      </button>
    </div>
  </template>
  
  <script>
    MishkahAuto.ready(M => {
      M.app.make({}, {
        mount: '#app',
        orders: {
          increment: {
            on: ['click'],
            handler: (e, app) => {
              app.setState(s => {
                s.data.count++;
                return s;
              });
            }
          }
        }
      });
    });
  <\/script>
</body>
</html>`;

            // Initialize CodeMirror
            let editor = null;

            function initEditor() {
                const container = document.getElementById('editor-container');
                if (!container || !window.CodeMirror) {
                    setTimeout(initEditor, 100);
                    return;
                }

                container.innerHTML = '';

                // Simple textarea fallback if CodeMirror fails
                const textarea = document.createElement('textarea');
                textarea.style.width = '100%';
                textarea.style.height = '100%';
                textarea.style.padding = '1rem';
                textarea.style.fontFamily = 'monospace';
                textarea.style.fontSize = '14px';
                textarea.style.background = 'var(--surface-2)';
                textarea.style.color = 'var(--foreground)';
                textarea.style.border = 'none';
                textarea.style.resize = 'none';
                textarea.value = defaultCode;
                container.appendChild(textarea);

                editor = {
                    getValue: () => textarea.value,
                    setValue: (val) => { textarea.value = val; }
                };

                // Auto-update preview on change
                textarea.addEventListener('input', () => {
                    updatePreview();
                });

                // Initial preview
                updatePreview();
            }

            function updatePreview() {
                if (!editor) return;

                const code = editor.getValue();
                const iframe = document.getElementById('preview-frame');
                if (!iframe) return;

                const doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
            }

            function downloadCode() {
                if (!editor) return;

                const code = editor.getValue();
                const blob = new Blob([code], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mishkah-example.html';
                a.click();
                URL.revokeObjectURL(url);
            }

            // Initialize editor when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initEditor);
            } else {
                initEditor();
            }
        </script>
    </template>

    <script>
        MishkahAuto.ready(M => {
            M.app.make({}, {
                mount: '#app',
                orders: {
                    toggleTheme: {
                        on: ['click'],
                        handler: (e, app) => {
                            app.setState(s => {
                                s.env.theme = s.env.theme === 'dark' ? 'light' : 'dark';
                                document.documentElement.setAttribute('data-theme', s.env.theme);
                                return s;
                            });
                        }
                    },
                    downloadCode: {
                        on: ['click'],
                        handler: () => downloadCode()
                    },
                    runCode: {
                        on: ['click'],
                        handler: () => updatePreview()
                    },
                    refreshPreview: {
                        on: ['click'],
                        handler: () => updatePreview()
                    },
                    formatCode: {
                        on: ['click'],
                        handler: () => {
                            alert('Format code feature coming soon!');
                        }
                    },
                    openInNewTab: {
                        on: ['click'],
                        handler: () => {
                            if (!editor) return;
                            const code = editor.getValue();
                            const win = window.open();
                            win.document.write(code);
                            win.document.close();
                        }
                    },
                    searchExamples: {
                        on: ['input'],
                        handler: (e, app) => {
                            app.setState(s => {
                                s.data.searchQuery = e.target.value;
                                return s;
                            });
                        }
                    },
                    selectExample: {
                        on: ['click'],
                        handler: (e, app) => {
                            const exampleId = e.target.closest('[data-example-id]')?.dataset.exampleId;
                            if (!exampleId) return;

                            // TODO: Load example from JSON
                            console.log('Loading example:', exampleId);
                        }
                    }
                }
            });
        });
    </script>
</body>

</html>